{% extends "base.html" %}

{% block title %}Ph√¢n t√≠ch B√ÅN - Crypto Prediction{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-1">
                <i class="bi bi-arrow-down-circle text-warning me-2"></i>
                Ph√¢n t√≠ch B√ÅN
            </h2>
        </div>
    </div>

    <!-- Coin Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-coin me-2"></i>
                        Ch·ªçn coin ƒë·ªÉ ph√¢n t√≠ch
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="baseCurrencySelect" class="form-label">Base Currency:</label>
                            <select id="baseCurrencySelect" class="form-select">
                                <option value="">Ch·ªçn base currency...</option>
                                {% for currency in base_currencies %}
                                <option value="{{ currency }}">{{ currency }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="coinSelect" class="form-label">Ch·ªçn coin:</label>
                            <select id="coinSelect" class="form-select" disabled>
                                <option value="">-- Ch·ªçn base currency tr∆∞·ªõc --</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button id="analyzeBtn" class="btn btn-warning btn-lg" disabled>
                                <i class="bi bi-search me-2"></i>
                                Ph√¢n t√≠ch xu h∆∞·ªõng
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Ch·ªçn base currency ƒë·ªÉ xem <strong>Top 15 coins</strong> c√≥ volume giao d·ªãch cao nh·∫•t
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="analysisStatus" class="alert alert-info d-none" role="alert">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                        <strong>ƒêang ph√¢n t√≠ch xu h∆∞·ªõng...</strong>
                        <div class="progress mt-2" style="width: 300px;">
                            <div id="analysisProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Alert -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="d-none">
        <!-- Coin Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h4 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            K·∫øt qu·∫£ ph√¢n t√≠ch: <span id="selectedCoin"></span>
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>üí∞ Gi√° hi·ªán t·∫°i</h5>
                                <h3 id="currentPrice" class="text-primary mb-0"></h3>
                            </div>
                            <div class="col-md-4">
                                <h5>‚è∞ Th·ªùi gian ph√¢n t√≠ch</h5>
                                <p id="analysisTime" class="mb-0"></p>
                            </div>
                            <div class="col-md-4">
                                <h5>üìä Khung th·ªùi gian</h5>
                                <p class="mb-0">60m, 4h, 1d</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trend Analysis Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>
                            Ph√¢n t√≠ch xu h∆∞·ªõng theo khung th·ªùi gian
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Khung th·ªùi gian</th>
                                        <th>Xu h∆∞·ªõng</th>
                                        <th>Khuy·∫øn ngh·ªã</th>
                                        <th>M·ª•c ti√™u</th>
                                        <th>T·ª∑ l·ªá</th>
                                        <th>ƒê·ªô ch√≠nh x√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="trendTableBody">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Recommendation -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="overallCard" class="card border-0 shadow-sm">
                    <div class="card-header" id="overallHeader">
                        <h4 class="mb-0">
                            <i class="bi bi-bullseye me-2"></i>
                            Khuy·∫øn ngh·ªã t·ªïng h·ª£p
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h3 id="overallAction" class="mb-2"></h3>
                                <p id="overallDetail" class="mb-2 fs-5"></p>
                                <p id="overallNote" class="text-muted mb-0"></p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div id="overallIcon" style="font-size: 4rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Info -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Th√¥ng tin b·ªï sung
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Ch·ªâ b√°o s·ª≠ d·ª•ng:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success me-2"></i>RSI (Relative Strength Index)</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>MACD (Moving Average Convergence Divergence)</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Ichimoku Cloud</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Fibonacci Retracement</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>L∆∞u √Ω quan tr·ªçng:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>ƒê√¢y ch·ªâ l√† c√¥ng c·ª• h·ªó tr·ª£</li>
                                    <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>Kh√¥ng ph·∫£i l·ªùi khuy√™n t√†i ch√≠nh</li>
                                    <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>T·ª± nghi√™n c·ª©u th√™m tr∆∞·ªõc khi quy·∫øt ƒë·ªãnh</li>
                                    <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>Crypto c√≥ r·ªßi ro cao</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Row Template -->
<template id="trendRowTemplate">
    <tr>
        <td class="timeframe-cell"></td>
        <td class="direction-cell"></td>
        <td class="recommendation-cell"></td>
        <td class="target-cell"></td>
        <td class="percentage-cell"></td>
        <td class="accuracy-cell"></td>
    </tr>
</template>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Handle base currency selection
    $('#baseCurrencySelect').change(function() {
        const baseCurrency = $(this).val();
        const coinSelect = $('#coinSelect');
        const analyzeBtn = $('#analyzeBtn');
        
        if (baseCurrency) {
            // Enable coin selection and show loading
            coinSelect.prop('disabled', false).html('<option value="">ƒêang t·∫£i...</option>');
            analyzeBtn.prop('disabled', true);
            
            // Fetch top coins for selected base currency
            $.ajax({
                url: `/api/coins/${baseCurrency}`,
                method: 'GET',
                success: function(response) {
                    if (response.success && response.coins) {
                        // Clear and populate coin options
                        coinSelect.empty().append('<option value="">Ch·ªçn coin</option>');
                        
                        response.coins.forEach(function(coin) {
                            coinSelect.append(`<option value="${coin.symbol}">${coin.symbol} - ${coin.volume_display}</option>`);
                        });
                    } else {
                        coinSelect.html('<option value="">L·ªói t·∫£i d·ªØ li·ªáu</option>');
                    }
                },
                error: function() {
                    coinSelect.html('<option value="">L·ªói k·∫øt n·ªëi</option>');
                }
            });
        } else {
            // Reset coin selection
            coinSelect.prop('disabled', true).html('<option value="">Ch·ªçn base currency tr∆∞·ªõc</option>');
            analyzeBtn.prop('disabled', true);
        }
    });
    
    // Handle coin selection
    $('#coinSelect').change(function() {
        const selected = $(this).val();
        $('#analyzeBtn').prop('disabled', !selected);
    });
    
    $('#analyzeBtn').click(function() {
        const selectedCoin = $('#coinSelect').val();
        if (selectedCoin) {
            runAnalysis(selectedCoin);
        }
    });
    
    function runAnalysis(symbol) {
        // Show loading state
        $('#analyzeBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>ƒêang ph√¢n t√≠ch...');
        $('#analysisStatus').removeClass('d-none');
        $('#errorAlert').addClass('d-none');
        $('#resultsSection').addClass('d-none');
        
        // Animate progress bar
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 25;
            if (progress > 90) progress = 90;
            $('#analysisProgress').css('width', progress + '%');
        }, 1000);
        
        // Make API call
        $.ajax({
            url: '/api/analyze_sell',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ symbol: symbol }),
            timeout: 60000, // 1 minute timeout
            success: function(response) {
                clearInterval(progressInterval);
                $('#analysisProgress').css('width', '100%');
                
                setTimeout(() => {
                    $('#analysisStatus').addClass('d-none');
                    if (response.success) {
                        displayResults(response);
                    } else {
                        showError('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh ph√¢n t√≠ch');
                    }
                    resetButton();
                }, 1000);
            },
            error: function(xhr, status, error) {
                clearInterval(progressInterval);
                $('#analysisStatus').addClass('d-none');
                
                let errorMsg = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                } else if (status === 'timeout') {
                    errorMsg = 'Timeout - Ph√¢n t√≠ch m·∫•t qu√° nhi·ªÅu th·ªùi gian';
                }
                
                showError(errorMsg);
                resetButton();
            }
        });
    }
    
    function displayResults(response) {
        const { symbol, analysis, overall, timestamp } = response;
        
        // Update coin info
        $('#selectedCoin').text(symbol);
        $('#analysisTime').text(timestamp);
        
        // Get current price from first available analysis
        const firstAnalysis = Object.values(analysis)[0];
        if (firstAnalysis && firstAnalysis.current_price !== 'N/A') {
            $('#currentPrice').text(firstAnalysis.current_price);
        } else {
            $('#currentPrice').text('N/A');
        }
        
        // Populate trend table
        const tableBody = $('#trendTableBody');
        tableBody.empty();
        
        Object.entries(analysis).forEach(([timeframe, data]) => {
            const template = $('#trendRowTemplate').prop('content').cloneNode(true);
            const $row = $(template).find('tr');
            
            $row.find('.timeframe-cell').html(`<strong>${data.timeframe_display}</strong>`);
            $row.find('.direction-cell').text(data.direction);
            
            // Recommendation with badge
            $row.find('.recommendation-cell').html(
                `<span class="badge bg-${data.rec_class}">${data.recommendation}</span><br>
                 <small class="text-muted">${data.recommendation_detail}</small>`
            );
            
            $row.find('.target-cell').text(data.tp_price);
            $row.find('.percentage-cell').html(
                `<span class="text-${data.tp_percent.startsWith('+') ? 'success' : 'danger'}">${data.tp_percent}%</span>`
            );
            $row.find('.accuracy-cell').text(data.accuracy + '%');
            
            tableBody.append($row);
        });
        
        // Update overall recommendation
        updateOverallRecommendation(overall);
        
        // Show results
        $('#resultsSection').removeClass('d-none');
        
        // Scroll to results
        $('html, body').animate({
            scrollTop: $('#resultsSection').offset().top - 100
        }, 1000);
    }
    
    function updateOverallRecommendation(overall) {
        const card = $('#overallCard');
        const header = $('#overallHeader');
        
        // Update header color
        header.removeClass('bg-success bg-warning bg-danger bg-info')
              .addClass(`bg-${overall.class}`);
        
        // Update content
        $('#overallAction').text(overall.action);
        $('#overallDetail').text(overall.detail);
        $('#overallNote').text(overall.note);
        
        // Update icon
        const icons = {
            'success': 'üîí',
            'danger': 'üí∏',
            'warning': 'üí∏', 
            'info': '‚è≥'
        };
        $('#overallIcon').text(icons[overall.class] || 'üìä');
    }
    
    function showError(message) {
        $('#errorMessage').text(message);
        $('#errorAlert').removeClass('d-none');
    }
    
    function resetButton() {
        $('#analyzeBtn').prop('disabled', false).html('<i class="bi bi-search me-2"></i>Ph√¢n t√≠ch xu h∆∞·ªõng');
    }
});
</script>
{% endblock %}
